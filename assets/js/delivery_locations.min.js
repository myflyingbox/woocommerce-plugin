var mfb_locations=null,infowindow=null,service_code="",gmap=null,geocoder=null,markers=[],locations_data=[];function init_gmap(){jQuery("#map-container").css("display","block");var o={zoom:11,mapTypeId:google.maps.MapTypeId.ROADMAP};gmap=new google.maps.Map(document.getElementById("map-canvas"),o),geocoder=new google.maps.Geocoder,infowindow=new google.maps.InfoWindow}function close_gmap(){jQuery("#map-container").css("display","none"),jQuery("#map-canvas").html("");for(var o=0;o<markers.length;o++)null!=markers[o]&&markers[o].setMap(null);markers=[],locations_data=[]}function update_zoom_gmap(){if(!(0==mfb_locations.length||0!=mfb_locations.length&&markers.length<mfb_locations.length)){for(var o=new google.maps.LatLngBounds,e=0;e<markers.length;e++)void 0!==markers[e]&&o.extend(markers[e].getPosition());gmap.setCenter(o.getCenter()),gmap.fitBounds(o),gmap.setZoom(gmap.getZoom()-1),15<gmap.getZoom()&&gmap.setZoom(15)}}function show_locations(o){for(i in mfb_locations=o.locations,init_gmap(),mfb_locations)loc=mfb_locations[i],function(n){var t=loc.company,o=loc.street,e=loc.city,a=loc.postal_code;info="<b>"+t+'</b><br/><u class="mfb-select-location" data="'+n+'">'+lang["Select this location"]+"</u><br/><span>"+o+", "+a+" "+e+'</span><br/><div class="mfb-opening-hours"><table>';var i=loc.opening_hours.sort(function(o,e){return o.day-e.day});for(j in i)day=i[j],info+="<tr>",info+="<td><b>"+lang["day_"+day.day]+"</b> : </td>",info+="<td>",info+=day.hours,info+="</td></tr>";info+="</table></div>",locations_data[n]=info,geocoder&&geocoder.geocode({address:o+", "+a+" "+e},function(o,e){var a;e==google.maps.GeocoderStatus.OK&&(0==n&&gmap.setCenter(o[0].geometry.location),(a=new google.maps.Marker({map:gmap,position:o[0].geometry.location,title:t})).set("content",locations_data[n]),google.maps.event.addListener(a,"click",function(){infowindow.close(),infowindow.setContent(this.get("content")),infowindow.open(gmap,a)}),markers[n]=a,update_zoom_gmap())})}(i);google.maps.event.addListener(gmap,"click",function(){infowindow.close()})}function select_location(o){code=mfb_locations[jQuery(o.target).attr("data")].code,name=mfb_locations[jQuery(o.target).attr("data")].company,jQuery("#input_"+service_code).html('<input type="hidden" name="_delivery_location" value="'+code+'"/>'),jQuery("#mfb-location-client").html(name),jQuery("#map-container").css("display","none"),close_gmap()}function error_loading_locations(o,e,a){alert(lang["Unable to load delivery locations"]+" : "+a)}jQuery(window).load(function(){jQuery("body").append(map),jQuery("body").delegate('[data-mfb-action="select-location"]',"click",function(){var o=jQuery(this).data("mfb-offer-uuid"),e=jQuery(this).data("mfb-instance-id");service_code=jQuery(this).data("mfb-method-id");var a=jQuery(this).closest("td");a.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),jQuery.ajax({url:mfb_params.ajaxurl,data:jQuery("form.checkout.woocommerce-checkout").serialize()+"&action="+mfb_params.action+"&k="+o+"&s="+service_code+"&i="+e,dataType:"json",timeout:15e3,error:error_loading_locations,success:show_locations,complete:function(){a.removeClass("processing").unblock()}})}),jQuery("#map-canvas").delegate(".mfb-select-location","click",select_location),jQuery(".mfb-close-map").click(close_gmap)});