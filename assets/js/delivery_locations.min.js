function init_gmap(){jQuery("#map-container").css("display","block");var a={zoom:11,mapTypeId:google.maps.MapTypeId.ROADMAP};gmap=new google.maps.Map(document.getElementById("map-canvas"),a),geocoder=new google.maps.Geocoder,infowindow=new google.maps.InfoWindow}function close_gmap(){jQuery("#map-container").css("display","none"),jQuery("#map-canvas").html("");for(var a=0;a<markers.length;a++)markers[a].setMap(null);markers=[],locations_data=[]}function update_zoom_gmap(){if(!(0==mfb_locations.length||0!=mfb_locations.length&&markers.length<mfb_locations.length)){for(var a=new google.maps.LatLngBounds,b=0;b<markers.length;b++)"undefined"!=typeof markers[b]&&a.extend(markers[b].getPosition());gmap.setCenter(a.getCenter()),gmap.fitBounds(a),gmap.setZoom(gmap.getZoom()-1),gmap.getZoom()>15&&gmap.setZoom(15)}}function show_locations(a){mfb_locations=a.locations,init_gmap();for(i in mfb_locations)loc=mfb_locations[i],function(a){var b=loc.company,c=loc.street,d=loc.city,e=loc.postal_code;info="<b>"+b+'</b><br/><u class="mfb-select-location" data="'+a+'">'+lang["Select this location"]+"</u><br/><span>"+c+", "+e+" "+d+'</span><br/><div class="mfb-opening-hours"><table>';var f=loc.opening_hours.sort(function(a,b){return a.day-b.day});for(j in f)day=f[j],info+="<tr>",info+="<td><b>"+lang["day_"+day.day]+"</b> : </td>",info+="<td>",info+=day.hours,info+="</td></tr>";info+="</table></div>",locations_data[a]=info,geocoder&&geocoder.geocode({address:c+", "+e+" "+d},function(c,d){if(d==google.maps.GeocoderStatus.OK){0==a&&gmap.setCenter(c[0].geometry.location);var e=new google.maps.Marker({map:gmap,position:c[0].geometry.location,title:b});e.set("content",locations_data[a]),google.maps.event.addListener(e,"click",function(){infowindow.close(),infowindow.setContent(this.get("content")),infowindow.open(gmap,e)}),markers[a]=e,update_zoom_gmap()}})}(i);google.maps.event.addListener(gmap,"click",function(){infowindow.close()})}function select_location(a){code=mfb_locations[jQuery(a.target).attr("data")].code,name=mfb_locations[jQuery(a.target).attr("data")].company,jQuery("#input_"+service_code).html('<input type="hidden" name="_delivery_location" value="'+code+'"/>'),jQuery("#mfb-location-client").html(name),jQuery("#map-container").css("display","none"),close_gmap()}function error_loading_locations(a,b,c){alert(lang["Unable to load delivery locations"]+" : "+c)}var mfb_locations=null,infowindow=null,service_code="",gmap=null,geocoder=null,markers=[],locations_data=[];jQuery(window).load(function(){jQuery("body").append(map),jQuery("body").delegate('[data-mfb-action="select-location"]',"click",function(){var a=jQuery(this).data("mfb-offer-uuid"),b=jQuery(this).data("mfb-instance-id");service_code=jQuery(this).data("mfb-method-id");var c=jQuery(this).closest("td");c.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),jQuery.ajax({url:mfb_params.ajaxurl,data:jQuery(this).closest("form.checkout.woocommerce-checkout").serialize()+"&action="+mfb_params.action+"&k="+a+"&s="+service_code+"&i="+b,dataType:"json",timeout:15e3,error:error_loading_locations,success:show_locations,complete:function(){c.removeClass("processing").unblock()}})}),jQuery("#map-canvas").delegate(".mfb-select-location","click",select_location),jQuery(".mfb-close-map").click(close_gmap)});