(function(o){var l=null,u=null,p="",c=null,g=null,s=[],h=[];function S(){o(".wc-block-components-radio-control__option").length&&o(".wc-block-components-radio-control__option").each(function(){const t=o(this),n=t.find('input[type="radio"]'),e=t.find("div.wc-block-components-radio-control__option-layout");if(n.length===0||e.find('[data-mfb-action="select-location"]').length>0)return;const a=n.val();o.ajax({url:mfb_var.ajax_url,method:"POST",data:{action:"get_delivery_location",method_id:a},success:function(r){r.success&&r.data.location&&(e.append(r.data.location),v())}})})}function b(){return{first_name:o("#shipping-first_name").val(),last_name:o("#shipping-last_name").val(),address_1:o("#shipping-address_1").val(),address_2:o("#shipping-address_2").val(),postcode:o("#shipping-postcode").val(),city:o("#shipping-city").val(),country:o("#shipping-country").val(),phone:o("#shipping-phone").val()}}function x(){const t=o(".wc-block-components-shipping-rates-control");if(t.length){const n=t.find(".wc-block-components-radio-control__input:checked");if(n.length)return n.closest(".wc-block-components-radio-control__option").find("[data-mfb-method-input-id]").data("mfb-method-input-id")||null}return null}function I(){const t=o(".wc-block-components-shipping-rates-control");if(t.length){const n=t.find(".wc-block-components-radio-control__input:checked");if(n.length)return n.closest(".wc-block-components-radio-control__option").find('input[name="_delivery_location"]').val()||null}return null}function v(){o("body").append(map),o("body").delegate('[data-mfb-action="select-location"]',"click",function(){var t=o(this).data("mfb-offer-uuid"),n=o(this).data("mfb-instance-id");p=o(this).data("mfb-method-id");var e=o(this).closest("td");if(e.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),o(".wc-block-checkout").length){const a=b();o.ajax({url:mfb_params.ajaxurl,method:"POST",data:{action:mfb_params.action,k:t,s:p,i:n,address:a},dataType:"json",timeout:15e3,error:w,success:k,complete:function(){e.removeClass("processing").unblock()}})}else o.ajax({url:mfb_params.ajaxurl,data:o("form.checkout.woocommerce-checkout").serialize()+"&action="+mfb_params.action+"&k="+t+"&s="+p+"&i="+n,dataType:"json",timeout:15e3,error:w,success:k,complete:function(){e.removeClass("processing").unblock()}})}),o("#map-canvas").delegate(".mfb-select-location","click",P),o(".mfb-close-map").click(y)}o(window).load(function(){if(o("body").hasClass("woocommerce-checkout")&&(v(),setTimeout(()=>S(),1e3),o(".wc-block-checkout").length)){const t=window.fetch;window.fetch=function(...n){const[e,a]=n;if(typeof e=="string"&&e.includes("/wc/store/v1/checkout")&&a?.method?.toUpperCase()==="POST"&&a?.body)try{const d=JSON.parse(a.body);d.extra_data={...d.extra_data||{},shipping_address:b(),shipping_method:x(),delivery_location:I()},a.body=JSON.stringify(d)}catch(d){console.warn("Erreur en injectant extra_data dans checkout body",d)}return t.apply(this,n)}}});function O(){o("#map-container").css("display","block");var t={zoom:11,mapTypeId:google.maps.MapTypeId.ROADMAP};c=new google.maps.Map(document.getElementById("map-canvas"),t),g=new google.maps.Geocoder,u=new google.maps.InfoWindow}function y(){o("#map-container").css("display","none"),o("#map-canvas").html("");for(var t=0;t<s.length;t++)s[t]!=null&&s[t].setMap(null);s=[],h=[]}function T(){if(!(l.length==0||l.length!=0&&s.length<l.length)){for(var t=new google.maps.LatLngBounds,n=0;n<s.length;n++)typeof s[n]<"u"&&t.extend(s[n].getPosition());c.setCenter(t.getCenter()),c.fitBounds(t),c.setZoom(c.getZoom()-1),c.getZoom()>15&&c.setZoom(15)}}function k(t){l=t.locations,O();for(i in l)loc=l[i],(function(n){var e=loc.company,a=loc.street,r=loc.city,d=loc.postal_code;info="<b>"+e+'</b><br/><u class="mfb-select-location" data="'+n+'">'+lang["Select this location"]+"</u><br/><span>"+a+", "+d+" "+r+'</span><br/><div class="mfb-opening-hours"><table>';var C=loc.opening_hours.sort(function(m,_){return m.day-_.day});for(j in C)day=C[j],info+="<tr>",info+="<td><b>"+lang["day_"+day.day]+"</b> : </td>",info+="<td>",info+=day.hours,info+="</td></tr>";info+="</table></div>",h[n]=info,g&&g.geocode({address:a+", "+d+" "+r},function(m,_){if(_==google.maps.GeocoderStatus.OK){n==0&&c.setCenter(m[0].geometry.location);var f=new google.maps.Marker({map:c,position:m[0].geometry.location,title:e});f.set("content",h[n]),google.maps.event.addListener(f,"click",function(){u.close(),u.setContent(this.get("content")),u.open(c,f)}),s[n]=f,T()}})})(i);google.maps.event.addListener(c,"click",function(){u.close()})}function P(t){code=l[o(t.target).attr("data")].code,name=l[o(t.target).attr("data")].company,o("#input_"+p).html('<input type="hidden" name="_delivery_location" value="'+code+'"/>'),o(".wc-block-checkout").length?(o("#mfb-location-client_"+p).html(name),o("#ilbl_"+p).show()):o("#mfb-location-client").html(name),o("#map-container").css("display","none"),y()}function w(t,n,e){alert(lang["Unable to load delivery locations"]+" : "+e)}})(jQuery);
