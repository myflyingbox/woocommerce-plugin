!function(o){var t=null,n=null,e="",a=null,c=null,l=[],s=[];function getShippingAddressData(){return{first_name:o("#shipping-first_name").val(),last_name:o("#shipping-last_name").val(),address_1:o("#shipping-address_1").val(),address_2:o("#shipping-address_2").val(),postcode:o("#shipping-postcode").val(),city:o("#shipping-city").val(),country:o("#shipping-country").val(),phone:o("#shipping-phone").val()}}function getSelectedShippingMethodId(){const t=o(".wc-block-components-shipping-rates-control");if(t.length){const o=t.find(".wc-block-components-radio-control__input:checked");if(o.length)return o.closest(".wc-block-components-radio-control__option").find("[data-mfb-method-input-id]").data("mfb-method-input-id")||null}return null}function getSelectedDeliveryLocation(){const t=o(".wc-block-components-shipping-rates-control");if(t.length){const o=t.find(".wc-block-components-radio-control__input:checked");if(o.length){return o.closest(".wc-block-components-radio-control__option").find('input[name="_delivery_location"]').val()||null}}return null}function load_map(){o("body").append(map),o("body").delegate('[data-mfb-action="select-location"]',"click",function(){var t=o(this).data("mfb-offer-uuid"),n=o(this).data("mfb-instance-id");e=o(this).data("mfb-method-id");var a=o(this).closest("td");if(a.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),o(".wc-block-checkout").length){const c=getShippingAddressData();o.ajax({url:mfb_params.ajaxurl,method:"POST",data:{action:mfb_params.action,k:t,s:e,i:n,address:c},dataType:"json",timeout:15e3,error:error_loading_locations,success:show_locations,complete:function(){a.removeClass("processing").unblock()}})}else o.ajax({url:mfb_params.ajaxurl,data:o("form.checkout.woocommerce-checkout").serialize()+"&action="+mfb_params.action+"&k="+t+"&s="+e+"&i="+n,dataType:"json",timeout:15e3,error:error_loading_locations,success:show_locations,complete:function(){a.removeClass("processing").unblock()}})}),o("#map-canvas").delegate(".mfb-select-location","click",select_location),o(".mfb-close-map").click(close_gmap)}function close_gmap(){o("#map-container").css("display","none"),o("#map-canvas").html("");for(var t=0;t<l.length;t++)null!=l[t]&&l[t].setMap(null);l=[],s=[]}function update_zoom_gmap(){if(!(0==t.length||0!=t.length&&l.length<t.length)){for(var o=new google.maps.LatLngBounds,n=0;n<l.length;n++)void 0!==l[n]&&o.extend(l[n].getPosition());a.setCenter(o.getCenter()),a.fitBounds(o),a.setZoom(a.getZoom()-1),a.getZoom()>15&&a.setZoom(15)}}function show_locations(e){for(i in t=e.locations,function init_gmap(){o("#map-container").css("display","block");var t={zoom:11,mapTypeId:google.maps.MapTypeId.ROADMAP};a=new google.maps.Map(document.getElementById("map-canvas"),t),c=new google.maps.Geocoder,n=new google.maps.InfoWindow}(),t)loc=t[i],function(o){var t=loc.company,e=loc.street,i=loc.city,d=loc.postal_code;info="<b>"+t+'</b><br/><u class="mfb-select-location" data="'+o+'">'+lang["Select this location"]+"</u><br/><span>"+e+", "+d+" "+i+'</span><br/><div class="mfb-opening-hours"><table>';var r=loc.opening_hours.sort(function(o,t){return o.day-t.day});for(j in r)day=r[j],info+="<tr>",info+="<td><b>"+lang["day_"+day.day]+"</b> : </td>",info+="<td>",info+=day.hours,info+="</td></tr>";info+="</table></div>",s[o]=info,c&&c.geocode({address:e+", "+d+" "+i},function(e,c){if(c==google.maps.GeocoderStatus.OK){0==o&&a.setCenter(e[0].geometry.location);var i=new google.maps.Marker({map:a,position:e[0].geometry.location,title:t});i.set("content",s[o]),google.maps.event.addListener(i,"click",function(){n.close(),n.setContent(this.get("content")),n.open(a,i)}),l[o]=i,update_zoom_gmap()}})}(i);google.maps.event.addListener(a,"click",function(){n.close()})}function select_location(n){code=t[o(n.target).attr("data")].code,name=t[o(n.target).attr("data")].company,o("#input_"+e).html('<input type="hidden" name="_delivery_location" value="'+code+'"/>'),o(".wc-block-checkout").length?(o("#mfb-location-client_"+e).html(name),o("#ilbl_"+e).show()):o("#mfb-location-client").html(name),o("#map-container").css("display","none"),close_gmap()}function error_loading_locations(o,t,n){alert(lang["Unable to load delivery locations"]+" : "+n)}o(window).load(function(){if(o("body").hasClass("woocommerce-checkout")&&(load_map(),setTimeout(()=>function addDeliveryLocation(){o(".wc-block-components-radio-control__option").length&&o(".wc-block-components-radio-control__option").each(function(){const t=o(this),n=t.find('input[type="radio"]'),e=t.find("div.wc-block-components-radio-control__option-layout");if(0===n.length||e.find('[data-mfb-action="select-location"]').length>0)return;const a=n.val();o.ajax({url:mfb_var.ajax_url,method:"POST",data:{action:"get_delivery_location",method_id:a},success:function(o){o.success&&o.data.location&&(e.append(o.data.location),load_map())}})})}(),1e3),o(".wc-block-checkout").length)){const o=window.fetch;window.fetch=function(...t){const[n,e]=t;if("string"==typeof n&&n.includes("/wc/store/v1/checkout")&&"POST"===e?.method?.toUpperCase()&&e?.body)try{const o=JSON.parse(e.body);o.extra_data={...o.extra_data||{},shipping_address:getShippingAddressData(),shipping_method:getSelectedShippingMethodId(),delivery_location:getSelectedDeliveryLocation()},e.body=JSON.stringify(o)}catch(o){console.warn("Erreur en injectant extra_data dans checkout body",o)}return o.apply(this,t)}}})}(jQuery);