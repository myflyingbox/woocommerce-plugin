!function(o){var t=[],e=null,n="",a=null,c=null,s=[],l=[];function addDeliveryLocation(){o(".wp-block-woocommerce-checkout-shipping-methods-block .wc-block-components-radio-control__option").length&&o(".wp-block-woocommerce-checkout-shipping-methods-block .wc-block-components-radio-control__option").each(function(){const t=o(this),e=t.find('input[type="radio"]'),n=t.find("div.wc-block-components-radio-control__option-layout");if(0===e.length||n.find('[data-mfb-action="select-location"]').length>0)return;const a=e.val();o.ajax({url:mfb_var.ajax_url,method:"POST",data:{action:"get_delivery_location",method_id:a},success:function(o){o.success&&o.data.location&&(n.append(o.data.location),load_map())}})})}function getShippingAddressData(){return{first_name:o("#shipping-first_name").val(),last_name:o("#shipping-last_name").val(),address_1:o("#shipping-address_1").val(),address_2:o("#shipping-address_2").val(),postcode:o("#shipping-postcode").val(),city:o("#shipping-city").val(),country:o("#shipping-country").val(),phone:o("#shipping-phone").val()}}function getSelectedShippingMethodId(){const t=o(".wc-block-components-shipping-rates-control");if(t.length){const o=t.find(".wc-block-components-radio-control__input:checked");if(o.length)return o.closest(".wc-block-components-radio-control__option").find("[data-mfb-method-input-id]").data("mfb-method-input-id")||null}return null}function getSelectedDeliveryLocation(){const t=o(".wc-block-components-shipping-rates-control");if(t.length){const o=t.find(".wc-block-components-radio-control__input:checked");if(o.length){return o.closest(".wc-block-components-radio-control__option").find('input[name="_delivery_location"]').val()||null}}return null}function load_map(){0===o("#map-container").length&&o("body").append(map),o("body").off("click",'[data-mfb-action="select-location"]'),o("body").delegate('[data-mfb-action="select-location"]',"click",function(){var t=o(this).data("mfb-offer-uuid"),e=o(this).data("mfb-instance-id");n=o(this).data("mfb-method-id");var a=o(this).closest("td");if(a.addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),o(".wc-block-checkout").length){const c=getShippingAddressData();o.ajax({url:mfb_params.ajaxurl,method:"POST",data:{action:mfb_params.action,k:t,s:n,i:e,address:c},dataType:"json",timeout:15e3,error:error_loading_locations,success:show_locations,complete:function(){a.removeClass("processing").unblock()}})}else o.ajax({url:mfb_params.ajaxurl,data:o("form.checkout.woocommerce-checkout").serialize()+"&action="+mfb_params.action+"&k="+t+"&s="+n+"&i="+e,dataType:"json",timeout:15e3,error:error_loading_locations,success:show_locations,complete:function(){a.removeClass("processing").unblock()}})}),o("#map-canvas").delegate(".mfb-select-location","click",select_location),o("body").delegate(".mfb-close-map","click",close_gmap)}function close_gmap(){o("#map-container").css("display","none"),o("#map-canvas").html("");for(var t=0;t<s.length;t++)null!=s[t]&&s[t].setMap(null);s=[],l=[]}function update_zoom_gmap(){if(!(null==t||0==t.length||0!=t.length&&s.length<t.length)){for(var o=new google.maps.LatLngBounds,e=0;e<s.length;e++)void 0!==s[e]&&o.extend(s[e].getPosition());a.setCenter(o.getCenter()),a.fitBounds(o),a.setZoom(a.getZoom()-1),a.getZoom()>15&&a.setZoom(15)}}function show_locations(n){for(i in t=n.locations,function init_gmap(){o("#map-container").css("display","block");var t={zoom:11,mapTypeId:google.maps.MapTypeId.ROADMAP};a=new google.maps.Map(document.getElementById("map-canvas"),t),c=new google.maps.Geocoder,e=new google.maps.InfoWindow}(),t)loc=t[i],function(o){var t=loc.company,n=loc.street,i=loc.city,d=loc.postal_code;info="<b>"+t+'</b><br/><u class="mfb-select-location" data="'+o+'">'+lang["Select this location"]+"</u><br/><span>"+n+", "+d+" "+i+'</span><br/><div class="mfb-opening-hours"><table>';var r=loc.opening_hours.sort(function(o,t){return o.day-t.day});for(j in r)day=r[j],info+="<tr>",info+="<td><b>"+lang["day_"+day.day]+"</b> : </td>",info+="<td>",info+=day.hours,info+="</td></tr>";info+="</table></div>",l[o]=info,c&&c.geocode({address:n+", "+d+" "+i},function(n,c){if(c==google.maps.GeocoderStatus.OK){0==o&&a.setCenter(n[0].geometry.location);var i=new google.maps.Marker({map:a,position:n[0].geometry.location,title:t});i.set("content",l[o]),google.maps.event.addListener(i,"click",function(){e.close(),e.setContent(this.get("content")),e.open(a,i)}),s[o]=i,update_zoom_gmap()}})}(i);google.maps.event.addListener(a,"click",function(){e.close()})}function select_location(e){code=t[o(e.target).attr("data")].code,name=t[o(e.target).attr("data")].company,o("#input_"+n).html('<input type="hidden" name="_delivery_location" value="'+code+'"/>'),o(".wc-block-checkout").length?(o("#mfb-location-client_"+n).html(name),o("#ilbl_"+n).show()):o("#mfb-location-client").html(name),o("#map-container").css("display","none"),close_gmap()}function error_loading_locations(o,t,e){alert(lang["Unable to load delivery locations"]+" : "+e)}o(window).on("load",function(){o("body").hasClass("woocommerce-checkout")&&(load_map(),setTimeout(()=>addDeliveryLocation(),1e3))}),o(document).ready(function(){const o=window.fetch;window.fetch=function(...t){const[e,n]=t,a="string"==typeof e&&e.includes("/wc/store/v1/batch"),c="string"==typeof e&&e.includes("/wc/store/v1/cart")&&e.includes("_locale=user");if("string"==typeof e&&e.includes("/wc/store/v1/checkout")&&"POST"===n?.method?.toUpperCase()&&n?.body){try{const o=JSON.parse(n.body);o.extra_data={...o.extra_data||{},shipping_address:getShippingAddressData(),shipping_method:getSelectedShippingMethodId(),delivery_location:getSelectedDeliveryLocation()},n.body=JSON.stringify(o)}catch(o){console.warn("Erreur en injectant extra_data dans checkout body",o)}return o.apply(this,t)}return a||c?a?o.apply(this,t).then(o=>{const t=o.clone();if(n?.body)try{const o=JSON.parse(n.body),e=o?.requests?.some(o=>"/wc/store/v1/cart/update-customer"===o.path);e&&t.json().then(()=>{setTimeout(()=>addDeliveryLocation(),1e3)})}catch(o){console.warn("Erreur de parsing batch body",o)}return o}):c?o.apply(this,t).then(o=>(o.clone().json().then(()=>{setTimeout(()=>addDeliveryLocation(),1e3)}),o)):void 0:o.apply(this,t)}})}(jQuery);